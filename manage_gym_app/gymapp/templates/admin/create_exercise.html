<div class="modal-header bg-primary text-white">
    <h5 class="modal-title"><i class="fa fa-running mr-2"></i> Thêm Bài Tập Mới</h5>
    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
        <span aria-hidden="true">&times;</span>
    </button>
</div>

<div class="modal-body">
    <div class="form-group mb-3">
        <label class="fw-bold">1. Tên bài tập</label>
        <input type="text" id="ex_name" class="form-control" placeholder="Nhập tên bài tập...">
    </div>
    <div class="form-group mb-3">
        <label class="fw-bold">2. Mô tả kỹ thuật</label>
        <textarea id="ex_desc" class="form-control" rows="3" placeholder="Mô tả động tác..."></textarea>
    </div>
    <div class="form-group mb-3">
        <label class="font-weight-bold">3. Link ảnh minh họa</label>
        <input type="text" id="ex_image" class="form-control" placeholder="Dán link ảnh (http/https)...">
    </div>
</div>

<div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
    <button type="button" class="btn btn-primary px-4 fw-bold btn-save-ex" onclick="saveExercise()">LƯU BÀI TẬP</button>
</div>
<script src="{{ url_for('static', filename='js/script.js') }}"></script>
<script>
function saveExercise() {
    const name = document.getElementById('ex_name').value.trim();
    const description = document.getElementById('ex_desc').value.trim();
    const image = document.getElementById('ex_image').value.trim();

    if (!name) {
        showToast("Tên bài tập không được để trống!", "danger");
        return;
    }
    if (name.length < 3 || name.length > 100) {
        showToast("Tên bài tập phải từ 3 đến 100 ký tự!", "warning");
        return;
    }

    if (!description) {
        showToast("Vui lòng nhập mô tả kỹ thuật bài tập!", "danger");
        return;
    }
    if (description.length < 10) {
        showToast("Mô tả quá ngắn!", "warning");
        return;
    }

    if (!image) {
        showToast("Vui lòng cung cấp đúng link ảnh minh họa!", "danger");
        return;
    }
    const urlPattern = /^(https?:\/\/.*\.(?:png|jpg|jpeg|gif|webp))$/i;
    if (!urlPattern.test(image)) {
        showToast("Link ảnh không hợp lệ!", "warning");
        return;
    }

    showConfirmDialog(
        "Xác nhận thêm bài tập",
        "Bạn có chắc chắn muốn thêm bài tập mới này không?",
        function() {
            fetch('/api/admin/exercises', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    'name': name,
                    'description': description,
                    'image': image
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 200) {
                    showToast(data.msg, "success");

                    if (typeof $ !== 'undefined') {
                        $('.modal.show').modal('hide');
                    }

                    // Reload lại trang sau 1.5s
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast("Lỗi: " + data.err_msg, "danger");
                }
            })
            .catch(err => {
                console.error(err);
                showToast("Đã có lỗi hệ thống xảy ra!", "danger");
            });
        }
    );
}
</script>