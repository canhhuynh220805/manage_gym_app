{% extends 'admin/master.html' %}

{% block body %}
{% if current_user.is_authenticated %}
<div class="container-fluid mt-3">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="text-secondary font-weight-bold">BẢNG ĐIỀU KHIỂN QUẢN TRỊ</h3>
    </div>

    <div class="row">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary  h-100 py-2">
                <div class="card-body">
                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Hội viên</div>
                    <div class="h5 mb-0 font-weight-bold ">{{ stats.members }}</div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success  h-100 py-2">
                <div class="card-body">
                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Huấn luyện viên</div>
                    <div class="h5 mb-0 font-weight-bold ">{{ stats.coaches }}</div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning  h-100 py-2">
                <div class="card-body">
                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Gói dịch vụ</div>
                    <div class="h5 mb-0 font-weight-bold ">{{ stats.packages }}</div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-danger  h-100 py-2">
                <div class="card-body">
                    <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Doanh thu tháng</div>
                    <div class="h5 mb-0 font-weight-bold text-danger">{{ "{:,.0f}".format(stats.revenue) }}đ</div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-2">
        <div class="col-lg-7 mb-4">
            <div class="card ">
                <div class="card-header py-3 bg-dark">
                    <h6 class="m-0 font-weight-bold text-white">Thống kê Gói tập</h6>
                </div>
                <div class="card-body p-0">
                    <table class="table table-hover mb-0">
                        <thead class="thead-light">
                            <tr>
                                <th>Tên gói</th>
                                <th class="text-center">Số lượng</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if pkg_stats %}
                                {% for p in pkg_stats %}
                                <tr>
                                    <td>{{ p[1] }}</td>
                                    <td class="text-center font-weight-bold text-primary">{{ p[2] }}</td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr><td colspan="2" class="text-center">Chưa có dữ liệu</td></tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-5 mb-4">
            <div class="card ">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-secondary">Tỷ lệ đăng ký</h6>
                </div>
                <div class="card-body">
                    <canvas id="myChart" style="max-height: 250px;"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        let labels = [];
        let data = [];
        {% if pkg_stats %}
            {% for p in pkg_stats %}
                labels.push('{{ p[1] }}');
                data.push({{ p[2] }});
            {% endfor %}
        {% endif %}

        const ctx = document.getElementById('myChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b']
                }]
            },
            options: { maintainAspectRatio: false }
        });
    });
</script>
{% else %}
<div class="container d-flex justify-content-center mt-5">
    <div class="card p-4" style="width: 400px;">
        <h4 class="text-center mb-4">Hệ Thống Admin</h4>
        <form method="post" action="/login">
            <div class="form-group">
                <input type="text" class="form-control" name="username" placeholder="Tài khoản" required>
            </div>
            <div class="form-group">
                <input type="password" class="form-control" name="password" placeholder="Mật khẩu" required>
            </div>
            <button type="submit" class="btn btn-primary btn-block">Đăng nhập</button>
        </form>
    </div>
</div>
{% endif %}
{% endblock %}